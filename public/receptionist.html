<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Receptionist Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="receptionist.css" />
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <h2 class="logo">
          <i class="fas fa-hospital"></i>
          <span>MedElite</span>
        </h2>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <header class="header">
          <div class="welcome">
            <i class="fas fa-user-nurse"></i>
            <span id="welcomeMessage">Welcome, Receptionist</span>
          </div>
          <button class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </header>

        <!-- Confirmed Appointments Section -->
        <section id="confirmed-appointments" class="card">
          <h2>
            <i class="far fa-calendar-alt"></i>
            <span>Confirmed Appointments</span>
          </h2>

          <div class="appointments-container">
            <table class="appointments-table">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Doctor</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Reason</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="confirmedAppointmentsTableBody">
                <!-- Confirmed appointments will be loaded here -->
              </tbody>
            </table>
            <p id="noConfirmedAppointments" class="no-appointments">
              No confirmed appointments found.
            </p>
          </div>
        </section>

        <!-- Completed Appointments Section -->
        <section id="completed-appointments" class="card">
          <h2>
            <i class="fas fa-calendar-check"></i>
            <span>Completed Appointments</span>
          </h2>

          <div class="appointments-container">
            <table class="appointments-table">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Doctor</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Reason</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="completedAppointmentsTableBody">
                <!-- Completed appointments will be loaded here -->
              </tbody>
            </table>
            <p id="noCompletedAppointments" class="no-appointments">
              No completed appointments found.
            </p>
          </div>
        </section>

        <!-- Updated Bill Generation Section -->
        <section id="bill-generation" class="card" style="display: none">
          <h2>
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Generate Bill</span>
          </h2>
          <div class="bill-form">
            <form id="billForm">
              <input type="hidden" id="billAppointmentId" />

              <!-- Patient Info (readonly) -->
              <div class="form-group">
                <label>Patient Name:</label>
                <input
                  type="text"
                  id="billPatientName"
                  readonly
                  class="readonly-field"
                />
              </div>

              <!-- Doctor Info (readonly) -->
              <div class="form-group">
                <label>Doctor:</label>
                <input
                  type="text"
                  id="billDoctorName"
                  readonly
                  class="readonly-field"
                />
              </div>

              <!-- Prescribed Medicines (display only) -->
              <div class="form-group" id="medicinesContainer">
                <label>Prescribed Medicines:</label>
                <div id="medicinesList" class="items-list"></div>
              </div>

              <!-- Medicine Costs -->
              <div class="form-group">
                <label>Medicine Costs:</label>
                <div id="medicineCosts" class="cost-inputs"></div>
              </div>

              <!-- Prescribed Tests (display only) -->
              <div class="form-group" id="testsContainer">
                <label>Prescribed Tests:</label>
                <div id="testsList" class="items-list"></div>
              </div>

              <!-- Test Costs -->
              <div class="form-group">
                <label>Test Costs:</label>
                <div id="testCosts" class="cost-inputs"></div>
              </div>

              <!-- Other Charges -->
              <div class="form-group">
                <label for="consultationFee">Consultation Fee ($):</label>
                <input
                  type="number"
                  id="consultationFee"
                  step="0.01"
                  min="0"
                  required
                />
              </div>

              <div class="form-group">
                <label for="otherCharges">Other Charges ($):</label>
                <input
                  type="number"
                  id="otherCharges"
                  step="0.01"
                  min="0"
                  value="0"
                />
              </div>

              <div class="form-group">
                <label for="notes">Notes:</label>
                <textarea id="notes" rows="3"></textarea>
              </div>

              <!-- Action Buttons -->
              <div class="form-actions">
                <button type="submit" class="submit-btn">
                  <i class="fas fa-file-invoice-dollar"></i> Generate Bill
                </button>
                <button type="button" id="cancelBillBtn" class="cancel-btn">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- Doctor Management Section -->
        <section id="doctor-management" class="card">
          <h2>
            <i class="fas fa-user-md"></i>
            <span>Doctor Management</span>
          </h2>

          <div class="doctors-container">
            <table class="doctors-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Specialization</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="doctorsTableBody">
                <!-- Doctors will be loaded here -->
              </tbody>
            </table>
            <p id="noDoctors" class="no-doctors">No doctors found.</p>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Base API URL
      const API_BASE_URL = "http://localhost:5000/api";
      let currentAppointmentId = null;

      // DOM Elements
      const welcomeMessage = document.getElementById("welcomeMessage");
      const confirmedAppointmentsTableBody = document.getElementById(
        "confirmedAppointmentsTableBody"
      );
      const completedAppointmentsTableBody = document.getElementById(
        "completedAppointmentsTableBody"
      );
      const noConfirmedAppointments = document.getElementById(
        "noConfirmedAppointments"
      );
      const noCompletedAppointments = document.getElementById(
        "noCompletedAppointments"
      );
      const doctorsTableBody = document.getElementById("doctorsTableBody");
      const noDoctors = document.getElementById("noDoctors");

      // Bill Generation Elements
      const billGenerationSection = document.getElementById("bill-generation");
      const billForm = document.getElementById("billForm");
      const cancelBillBtn = document.getElementById("cancelBillBtn");

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        // Check if user is logged in
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        // Set welcome message
        const userData = parseJwt(token);
        if (userData) {
          welcomeMessage.textContent = `Welcome, ${userData.name}`;
        }

        // Load initial data
        loadConfirmedAppointments();
        loadCompletedAppointments();
        loadDoctors();

        // Set up bill form
        billForm.addEventListener("submit", handleBillSubmit);
        cancelBillBtn.addEventListener("click", function () {
          billGenerationSection.style.display = "none";
        });

        // Set up logout button
        document
          .querySelector(".logout-btn")
          .addEventListener("click", function () {
            localStorage.removeItem("token");
            window.location.href = "login.html";
          });
      });

      // Parse JWT token
      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            window
              .atob(base64)
              .split("")
              .map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join("")
          );

          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

      // Load confirmed appointments
      async function loadConfirmedAppointments() {
        try {
          const response = await fetch(
            `${API_BASE_URL}/receptionist/appointments/confirmed`
          );
          const appointments = await response.json();

          // Clear table
          confirmedAppointmentsTableBody.innerHTML = "";

          if (appointments.length > 0) {
            noConfirmedAppointments.style.display = "none";

            // Populate table
            appointments.forEach((appointment) => {
              const row = document.createElement("tr");
              row.dataset.id = appointment._id;

              const patientCell = document.createElement("td");
              patientCell.textContent = appointment.patientId?.name || "N/A";

              const doctorCell = document.createElement("td");
              doctorCell.textContent = appointment.doctorId?.name || "N/A";

              const dateCell = document.createElement("td");
              const date = new Date(appointment.date);
              dateCell.textContent = date.toLocaleDateString("en-US", {
                weekday: "short",
                month: "short",
                day: "numeric",
                year: "2-digit",
              });

              const timeCell = document.createElement("td");
              timeCell.textContent = appointment.time;

              const reasonCell = document.createElement("td");
              reasonCell.textContent =
                appointment.reason || "General Consultation";

              const statusCell = document.createElement("td");
              const statusBadge = document.createElement("span");
              statusBadge.className = `status-badge status-${appointment.status.replace(
                " ",
                "-"
              )}`;
              statusBadge.textContent = appointment.status;
              statusCell.appendChild(statusBadge);

              const actionCell = document.createElement("td");
              actionCell.className = "actions";

              if (appointment.status === "confirmed") {
                const checkinBtn = document.createElement("button");
                checkinBtn.className = "checkin-btn";
                checkinBtn.innerHTML =
                  '<i class="fas fa-sign-in-alt"></i> Check In';
                checkinBtn.addEventListener("click", () =>
                  checkInPatient(appointment._id)
                );
                actionCell.appendChild(checkinBtn);
              } else if (appointment.status === "checked-in") {
                const checkoutBtn = document.createElement("button");
                checkoutBtn.className = "checkout-btn";
                checkoutBtn.innerHTML =
                  '<i class="fas fa-sign-out-alt"></i> Check Out';
                checkoutBtn.addEventListener("click", () =>
                  openBillForm(appointment)
                );
                actionCell.appendChild(checkoutBtn);
              }

              row.appendChild(patientCell);
              row.appendChild(doctorCell);
              row.appendChild(dateCell);
              row.appendChild(timeCell);
              row.appendChild(reasonCell);
              row.appendChild(statusCell);
              row.appendChild(actionCell);

              confirmedAppointmentsTableBody.appendChild(row);
            });
          } else {
            noConfirmedAppointments.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading confirmed appointments:", error);
          alert("Failed to load confirmed appointments. Please try again.");
        }
      }

      // Load completed appointments
      async function loadCompletedAppointments() {
        try {
          const response = await fetch(
            `${API_BASE_URL}/receptionist/appointments/completed`
          );
          const appointments = await response.json();

          // Clear table
          completedAppointmentsTableBody.innerHTML = "";

          if (appointments.length > 0) {
            noCompletedAppointments.style.display = "none";

            // Populate table
            appointments.forEach((appointment) => {
              const row = document.createElement("tr");
              row.dataset.id = appointment._id;

              const patientCell = document.createElement("td");
              patientCell.textContent = appointment.patientId?.name || "N/A";

              const doctorCell = document.createElement("td");
              doctorCell.textContent = appointment.doctorId?.name || "N/A";

              const dateCell = document.createElement("td");
              const date = new Date(appointment.date);
              dateCell.textContent = date.toLocaleDateString("en-US", {
                weekday: "short",
                month: "short",
                day: "numeric",
                year: "2-digit",
              });

              const timeCell = document.createElement("td");
              timeCell.textContent = appointment.time;

              const reasonCell = document.createElement("td");
              reasonCell.textContent =
                appointment.reason || "General Consultation";

              const statusCell = document.createElement("td");
              const statusBadge = document.createElement("span");
              statusBadge.className = `status-badge status-${appointment.status.replace(
                " ",
                "-"
              )}`;
              statusBadge.textContent = appointment.status;
              statusCell.appendChild(statusBadge);

              const actionCell = document.createElement("td");
              actionCell.className = "actions";

              const generateBillBtn = document.createElement("button");
              generateBillBtn.className = "generate-bill-btn";
              generateBillBtn.innerHTML =
                '<i class="fas fa-file-invoice-dollar"></i> View Bill';
              generateBillBtn.addEventListener("click", () =>
                openBillForm(appointment, true)
              );
              actionCell.appendChild(generateBillBtn);

              row.appendChild(patientCell);
              row.appendChild(doctorCell);
              row.appendChild(dateCell);
              row.appendChild(timeCell);
              row.appendChild(reasonCell);
              row.appendChild(statusCell);
              row.appendChild(actionCell);

              completedAppointmentsTableBody.appendChild(row);
            });
          } else {
            noCompletedAppointments.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading completed appointments:", error);
          alert("Failed to load completed appointments. Please try again.");
        }
      }

      // Load doctors
      async function loadDoctors() {
        try {
          // Change this line to fetch pending doctors instead of all doctors
          const response = await fetch(
            `${API_BASE_URL}/receptionist/doctors/pending`
          );
          const pendingDoctors = await response.json();

          // Clear table
          doctorsTableBody.innerHTML = "";

          if (pendingDoctors.length > 0) {
            noDoctors.style.display = "none";

            // Populate table with pending doctors
            pendingDoctors.forEach((doctor) => {
              const row = document.createElement("tr");
              row.dataset.id = doctor._id;

              const nameCell = document.createElement("td");
              nameCell.textContent = doctor.name;

              const specializationCell = document.createElement("td");
              specializationCell.textContent =
                doctor.specialization || "General Practitioner";

              const emailCell = document.createElement("td");
              emailCell.textContent = doctor.email;

              const statusCell = document.createElement("td");
              const statusBadge = document.createElement("span");
              statusBadge.className = "status-badge status-pending";
              statusBadge.textContent = "Pending Approval";
              statusCell.appendChild(statusBadge);

              const actionCell = document.createElement("td");
              actionCell.className = "actions";

              // Add approve button for pending doctors
              const approveBtn = document.createElement("button");
              approveBtn.className = "approve-btn";
              approveBtn.innerHTML =
                '<i class="fas fa-check-circle"></i> Approve';
              approveBtn.addEventListener("click", () =>
                approveDoctor(doctor._id)
              );
              actionCell.appendChild(approveBtn);

              row.appendChild(nameCell);
              row.appendChild(specializationCell);
              row.appendChild(emailCell);
              row.appendChild(statusCell);
              row.appendChild(actionCell);

              doctorsTableBody.appendChild(row);
            });
          } else {
            noDoctors.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading pending doctors:", error);
          alert("Failed to load pending doctors. Please try again.");
        }
      }
      // Check in patient
      async function checkInPatient(appointmentId) {
        if (!confirm("Are you sure you want to check in this patient?")) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/receptionist/appointments/${appointmentId}/checkin`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to check in patient");
          }

          const result = await response.json();
          alert("Patient checked in successfully!");
          loadConfirmedAppointments();
        } catch (error) {
          console.error("Error checking in patient:", error);
          alert("Failed to check in patient. Please try again.");
        }
      }

      // Open bill form
      function openBillForm(appointment, viewOnly = false) {
        currentAppointmentId = appointment._id;
        billGenerationSection.style.display = "block";
        billGenerationSection.scrollIntoView({ behavior: "smooth" });

        // Fill basic appointment info
        document.getElementById("billAppointmentId").value = appointment._id;
        document.getElementById("billPatientName").value =
          appointment.patientId?.name || "N/A";
        document.getElementById("billDoctorName").value =
          appointment.doctorId?.name || "N/A";

        // Clear previous data
        document.getElementById("medicinesList").innerHTML = "";
        document.getElementById("medicineCosts").innerHTML = "";
        document.getElementById("testsList").innerHTML = "";
        document.getElementById("testCosts").innerHTML = "";
        document.getElementById("notes").value = "";

        // Display medicines and add price inputs
        if (appointment.prescription?.medicines?.length > 0) {
          appointment.prescription.medicines.forEach((medicine, index) => {
            // Display medicine name
            const medItem = document.createElement("div");
            medItem.className = "item-name";
            medItem.textContent = `${medicine.name} (${medicine.dosage}, ${medicine.duration})`;
            document.getElementById("medicinesList").appendChild(medItem);

            // Add price input
            const costInput = document.createElement("input");
            costInput.type = "number";
            costInput.step = "0.01";
            costInput.min = "0";
            costInput.placeholder = "Enter price";
            costInput.required = true;
            costInput.className = "price-input";
            costInput.dataset.medicineId = medicine._id;

            // If viewing existing bill, populate the price
            if (viewOnly && appointment.bill) {
              const medBill = appointment.bill.medicines.find(
                (m) => m.medicineId === medicine._id
              );
              if (medBill) {
                costInput.value = medBill.price;
                costInput.readOnly = true;
              }
            }

            document.getElementById("medicineCosts").appendChild(costInput);
          });
        } else {
          document.getElementById("medicinesList").innerHTML =
            "<div class='no-items'>No medicines prescribed</div>";
        }

        // Display tests and add price inputs
        if (appointment.prescription?.tests?.length > 0) {
          appointment.prescription.tests.forEach((test, index) => {
            // Display test name
            const testItem = document.createElement("div");
            testItem.className = "item-name";
            testItem.textContent = test.name;
            document.getElementById("testsList").appendChild(testItem);

            // Add price input
            const costInput = document.createElement("input");
            costInput.type = "number";
            costInput.step = "0.01";
            costInput.min = "0";
            costInput.placeholder = "Enter price";
            costInput.className = "price-input";
            costInput.dataset.testId = test._id;

            // If viewing existing bill, populate the price
            if (viewOnly && appointment.bill) {
              const testBill = appointment.bill.tests.find(
                (t) => t.testId === test._id
              );
              if (testBill) {
                costInput.value = testBill.price;
                costInput.readOnly = true;
              }
            }

            document.getElementById("testCosts").appendChild(costInput);
          });
        } else {
          document.getElementById("testsList").innerHTML =
            "<div class='no-items'>No tests ordered</div>";
        }

        // Set consultation fee and other charges
        if (viewOnly && appointment.bill) {
          document.getElementById("consultationFee").value =
            appointment.bill.consultationFee || "";
          document.getElementById("otherCharges").value =
            appointment.bill.otherCharges || "0";
          document.getElementById("notes").value = appointment.bill.notes || "";

          // Make fields read-only
          document.getElementById("consultationFee").readOnly = true;
          document.getElementById("otherCharges").readOnly = true;
          document.getElementById("notes").readOnly = true;

          // Hide submit button
          document.querySelector(".submit-btn").style.display = "none";
        } else {
          // Clear and enable fields for new bill
          document.getElementById("consultationFee").value = "";
          document.getElementById("otherCharges").value = "0";
          document.getElementById("notes").value = "";

          document.getElementById("consultationFee").readOnly = false;
          document.getElementById("otherCharges").readOnly = false;
          document.getElementById("notes").readOnly = false;

          // Show submit button
          document.querySelector(".submit-btn").style.display = "block";
        }
      }

      // Handle bill submission
      async function handleBillSubmit(e) {
        e.preventDefault();

        if (!currentAppointmentId) return;

        // Collect medicine costs WITH NAMES
        const medicines = [];
        const medicineInputs = document.querySelectorAll(
          "#medicineCosts input"
        );
        const medicineNames = document.querySelectorAll(
          "#medicinesList .item-name"
        );

        medicineInputs.forEach((input, index) => {
          if (input.value) {
            medicines.push({
              medicineId: input.dataset.medicineId,
              name:
                medicineNames[index]?.textContent.split(" (")[0] || "Medicine", // Extract name
              price: parseFloat(input.value),
            });
          }
        });

        // Collect test costs WITH NAMES
        const tests = [];
        const testInputs = document.querySelectorAll("#testCosts input");
        const testNames = document.querySelectorAll("#testsList .item-name");

        testInputs.forEach((input, index) => {
          if (input.value) {
            tests.push({
              testId: input.dataset.testId,
              name: testNames[index]?.textContent || "Test", // Extract name
              price: parseFloat(input.value),
            });
          }
        });

        // Calculate total bill amount
        const consultationFee =
          parseFloat(document.getElementById("consultationFee").value) || 0;
        const otherCharges =
          parseFloat(document.getElementById("otherCharges").value) || 0;

        const billAmount =
          consultationFee +
          medicines.reduce((sum, med) => sum + med.price, 0) +
          tests.reduce((sum, test) => sum + test.price, 0) +
          otherCharges;

        const notes = document.getElementById("notes").value;

        try {
          const response = await fetch(
            `${API_BASE_URL}/receptionist/appointments/${currentAppointmentId}/checkout`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({
                billAmount,
                medicines,
                tests,
                otherCharges,
                notes,
              }),
            }
          );

          if (!response.ok) throw new Error("Failed to generate bill");

          const result = await response.json();
          alert("Bill generated successfully!");
          billGenerationSection.style.display = "none";
          loadConfirmedAppointments();
          loadCompletedAppointments();
        } catch (error) {
          console.error("Error generating bill:", error);
          alert("Failed to generate bill. Please try again.");
        }
      }
      // Approve doctor
      async function approveDoctor(doctorId) {
        if (!confirm("Are you sure you want to approve this doctor?")) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/receptionist/doctors/${doctorId}/approve`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to approve doctor");
          }

          const result = await response.json();
          alert("Doctor approved successfully!");
          loadDoctors(); // Refresh the list
        } catch (error) {
          console.error("Error approving doctor:", error);
          alert("Failed to approve doctor. Please try again.");
        }
      }
    </script>
  </body>
</html>

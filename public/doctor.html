<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="doctor.css" />
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <h2 class="logo">
          <i class="fas fa-hospital"></i>
          <span>MedElite</span>
        </h2>
        <nav>
          <ul class="nav-links">
            <li>
              <a href="#appointments">
                <i class="fas fa-calendar-alt"></i><span>Appointments</span>
              </a>
            </li>
            <li>
              <a href="#prescriptions">
                <i class="fas fa-file-prescription"></i
                ><span>Prescriptions</span>
              </a>
            </li>
            <li>
              <a href="#slot-management">
                <i class="fas fa-clock"></i><span>Slot Management</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <header class="header">
          <div class="welcome">
            <i class="fas fa-user-md"></i>
            <span id="welcomeMessage">Welcome, Doctor</span>
          </div>
          <button class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </header>

        <section id="appointments" class="card">
          <h2>
            <i class="far fa-calendar-alt"></i>
            <span>Today's Appointments</span>
          </h2>
          <div class="appointments-container">
            <table class="appointments-table">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Time</th>
                  <th>Reason</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="appointmentsTableBody">
                <!-- Appointments will be populated by JavaScript -->
              </tbody>
            </table>
            <p id="noAppointments" class="no-appointments">
              No appointments scheduled for today.
            </p>
          </div>

          <!-- Patient Details Section -->
          <div id="patientDetails" class="patient-details">
            <h3>Patient Information</h3>
            <div class="patient-info">
              <div class="patient-info-column">
                <p><strong>Name:</strong> <span id="patientName"></span></p>
                <p><strong>Age:</strong> <span id="patientAge"></span></p>
                <p><strong>Gender:</strong> <span id="patientGender"></span></p>
              </div>
              <div class="patient-info-column">
                <p><strong>Phone:</strong> <span id="patientPhone"></span></p>
                <p><strong>Email:</strong> <span id="patientEmail"></span></p>
                <p>
                  <strong>Blood Group:</strong>
                  <span id="patientBloodGroup"></span>
                </p>
              </div>
            </div>
            <h3>Medical History</h3>
            <div id="medicalHistory">
              <!-- Medical history will be populated by JavaScript -->
            </div>

            <!-- Prescription Form -->
            <div id="prescriptionForm" class="prescription-form">
              <h3>Create Prescription</h3>
              <form id="createPrescriptionForm">
                <input type="hidden" id="appointmentId" name="appointmentId" />
                <input type="hidden" id="patientId" name="patientId" />

                <div class="form-group">
                  <label for="notes">Clinical Notes</label>
                  <textarea
                    id="notes"
                    name="notes"
                    rows="4"
                    placeholder="Enter clinical notes..."
                  ></textarea>
                </div>

                <div class="form-group">
                  <h4>Medicines</h4>
                  <div id="medicinesContainer">
                    <div class="medicine-item">
                      <input
                        type="text"
                        name="medicineName[]"
                        placeholder="Medicine name"
                        required
                      />
                      <input
                        type="text"
                        name="medicineDosage[]"
                        placeholder="Dosage"
                        required
                      />
                      <input
                        type="text"
                        name="medicineDuration[]"
                        placeholder="Duration"
                        required
                      />
                      <button
                        type="button"
                        class="remove-btn"
                        onclick="removeMedicineItem(this)"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <button
                    type="button"
                    class="add-btn"
                    onclick="addMedicineItem()"
                  >
                    <i class="fas fa-plus"></i> Add Medicine
                  </button>
                </div>

                <div class="form-group">
                  <h4>Tests</h4>
                  <div id="testsContainer">
                    <div class="test-item">
                      <input
                        type="text"
                        name="testName[]"
                        placeholder="Test name"
                      />
                      <button
                        type="button"
                        class="remove-btn"
                        onclick="removeTestItem(this)"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <button type="button" class="add-btn" onclick="addTestItem()">
                    <i class="fas fa-plus"></i> Add Test
                  </button>
                </div>

                <button type="submit" class="submit-btn">
                  <i class="fas fa-save"></i> Save Prescription
                </button>
              </form>
            </div>
          </div>
        </section>

        <section id="prescriptions" class="card">
          <h2>
            <i class="fas fa-file-prescription"></i>
            <span>Recent Prescriptions</span>
          </h2>
          <div id="prescriptionsList">
            <p class="no-records">No recent prescriptions found.</p>
          </div>
        </section>
        <section id="slot-management" class="card">
          <h2>
            <i class="fas fa-clock"></i>
            <span>Add Available Slots</span>
          </h2>

          <div class="simple-slot-form">
            <div class="form-group">
              <label for="slotDate">Select Date</label>
              <input type="date" id="slotDate" name="date" required />
            </div>

            <div class="form-group">
              <label>Select Time Slots</label>
              <div class="time-slots">
                <label class="time-slot">
                  <input type="checkbox" name="time" value="09:00" /> 9:00 AM
                </label>
                <label class="time-slot">
                  <input type="checkbox" name="time" value="10:00" /> 10:00 AM
                </label>
                <label class="time-slot">
                  <input type="checkbox" name="time" value="11:00" /> 11:00 AM
                </label>
                <label class="time-slot">
                  <input type="checkbox" name="time" value="12:00" /> 12:00 PM
                </label>
                <label class="time-slot">
                  <input type="checkbox" name="time" value="14:00" /> 2:00 PM
                </label>
                <label class="time-slot">
                  <input type="checkbox" name="time" value="15:00" /> 3:00 PM
                </label>
                <label class="time-slot">
                  <input type="checkbox" name="time" value="16:00" /> 4:00 PM
                </label>
                <label class="time-slot">
                  <input type="checkbox" name="time" value="17:00" /> 5:00 PM
                </label>
              </div>
            </div>

            <button id="saveSlotsBtn" class="submit-btn">
              <i class="fas fa-save"></i> Save Slots
            </button>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Base API URL
      const API_BASE_URL = "http://localhost:5000/api";

      // DOM Elements
      const welcomeMessage = document.getElementById("welcomeMessage");
      const appointmentsTableBody = document.getElementById(
        "appointmentsTableBody"
      );
      const noAppointments = document.getElementById("noAppointments");
      const patientDetails = document.getElementById("patientDetails");
      const prescriptionForm = document.getElementById("prescriptionForm");
      const createPrescriptionForm = document.getElementById(
        "createPrescriptionForm"
      );
      const prescriptionsList = document.getElementById("prescriptionsList");

      // Current doctor data
      let currentDoctor = {
        id: null,
        name: null,
        email: null,
        specialization: null,
      };

      // Initialize the application when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Get doctor data from session (in a real app, this would come from authentication)
        const token = localStorage.getItem("token");

        function parseJwt(token) {
          try {
            const base64Url = token.split(".")[1];
            const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
            const jsonPayload = decodeURIComponent(
              atob(base64)
                .split("")
                .map(
                  (c) => `%${("00" + c.charCodeAt(0).toString(16)).slice(-2)}`
                )
                .join("")
            );
            return JSON.parse(jsonPayload);
          } catch (e) {
            return null;
          }
        }

        if (token) {
          const userData = parseJwt(token);
          if (userData) {
            currentDoctor = {
              id: userData.userId,
              name: userData.name,
              email: userData.email,
              specialization: userData.specialization || "General Practitioner",
            };
            welcomeMessage.textContent = `Welcome, Dr. ${currentDoctor.name}`;
            loadDoctorAppointments();
            loadRecentPrescriptions();
            // Call this function when the page loads (add to your DOMContentLoaded event)
            loadDoctorSlots();
          }
        } else {
          // Redirect to login if no token
          window.location.href = "login.html";
        }

        // Initialize logout button
        document
          .querySelector(".logout-btn")
          .addEventListener("click", function () {
            localStorage.removeItem("token");
            window.location.href = "/login";
          });
      });

      // Load doctor's appointments
      async function loadDoctorAppointments() {
        try {
          console.log(currentDoctor);
          const response = await fetch(
            `${API_BASE_URL}/doctor/appointments/${currentDoctor.id}`
          );
          const appointments = await response.json();

          // Clear previous appointments
          appointmentsTableBody.innerHTML = "";

          if (appointments.length > 0) {
            noAppointments.style.display = "none";

            // Populate appointments table
            appointments.forEach((appointment) => {
              const row = document.createElement("tr");
              row.dataset.appointmentId = appointment._id;
              row.dataset.patientId = appointment.patientId._id;

              const patientCell = document.createElement("td");
              patientCell.textContent = appointment.patientId.name;

              const timeCell = document.createElement("td");
              timeCell.textContent = appointment.time;

              const reasonCell = document.createElement("td");
              reasonCell.textContent = appointment.reason;

              const statusCell = document.createElement("td");
              const statusBadge = document.createElement("span");
              statusBadge.className = `status-badge status-${appointment.status.replace(
                " ",
                "-"
              )}`;
              statusBadge.textContent = appointment.status;
              statusCell.appendChild(statusBadge);

              const actionCell = document.createElement("td");
              const selectButton = document.createElement("button");
              selectButton.className = "select-patient-btn";
              selectButton.textContent = "Select";
              selectButton.addEventListener("click", () =>
                showPatientDetails(appointment)
              );
              actionCell.appendChild(selectButton);

              row.appendChild(patientCell);
              row.appendChild(timeCell);
              row.appendChild(reasonCell);
              row.appendChild(statusCell);
              row.appendChild(actionCell);

              appointmentsTableBody.appendChild(row);
            });
          } else {
            noAppointments.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading appointments:", error);
          alert("Failed to load appointments. Please try again.");
        }
      }

      // Show patient details
      async function showPatientDetails(appointment) {
        try {
          // Show patient details section
          patientDetails.style.display = "block";

          // Populate basic patient info
          document.getElementById("patientName").textContent =
            appointment.patientId.name;
          document.getElementById("patientEmail").textContent =
            appointment.patientId.email || "N/A";
          document.getElementById("patientPhone").textContent =
            appointment.phoneNumber || "N/A";
          document.getElementById("patientAge").textContent =
            appointment.age || "N/A";
          document.getElementById("patientGender").textContent =
            appointment.gender || "N/A";
          document.getElementById("patientBloodGroup").textContent =
            appointment.patientId.bloodGroup || "N/A";

          // Set hidden fields for prescription form
          document.getElementById("appointmentId").value = appointment._id;
          document.getElementById("patientId").value =
            appointment.patientId._id;

          // Show prescription form
          prescriptionForm.style.display = "block";

          // Scroll to patient details
          patientDetails.scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          console.error("Error showing patient details:", error);
          alert("Failed to load patient details. Please try again.");
        }
      }

      // Load recent prescriptions
      async function loadRecentPrescriptions() {
        try {
          const response = await fetch(
            `${API_BASE_URL}/doctor/prescriptions/${currentDoctor.id}`
          );
          const prescriptions = await response.json();

          // Clear previous prescriptions
          prescriptionsList.innerHTML = "";

          if (prescriptions.length > 0) {
            const noRecords = prescriptionsList.querySelector(".no-records");
            if (noRecords) noRecords.remove();

            prescriptions.forEach((prescription) => {
              const prescriptionCard = document.createElement("div");
              prescriptionCard.className = "prescription-card";
              prescriptionCard.style.marginBottom = "20px";
              prescriptionCard.style.padding = "15px";
              prescriptionCard.style.border = "1px solid #e5e7eb";
              prescriptionCard.style.borderRadius = "8px";

              const date = new Date(
                prescription.createdAt
              ).toLocaleDateString();
              const patientName = prescription.patientId.name;

              prescriptionCard.innerHTML = `
                <h3>Prescription for ${patientName} - ${date}</h3>
                ${
                  prescription.medicines.length > 0
                    ? `
                  <h4>Medicines:</h4>
                  <ul>
                    ${prescription.medicines
                      .map(
                        (med) =>
                          `<li>${med.name} - ${med.dosage} for ${med.duration}</li>`
                      )
                      .join("")}
                  </ul>
                `
                    : ""
                }
                ${
                  prescription.tests.length > 0
                    ? `
                  <h4>Tests:</h4>
                  <ul>
                    ${prescription.tests
                      .map((test) => `<li>${test.name}</li>`)
                      .join("")}
                  </ul>
                `
                    : ""
                }
                ${
                  prescription.notes
                    ? `<p><strong>Notes:</strong> ${prescription.notes}</p>`
                    : ""
                }
              `;

              prescriptionsList.appendChild(prescriptionCard);
            });
          } else {
            const noRecords = document.createElement("p");
            noRecords.className = "no-records";
            noRecords.textContent = "No recent prescriptions found.";
            prescriptionsList.appendChild(noRecords);
          }
        } catch (error) {
          console.error("Error loading prescriptions:", error);
          alert("Failed to load prescriptions. Please try again.");
        }
      }

      // Add medicine item to form
      function addMedicineItem() {
        const container = document.getElementById("medicinesContainer");
        const newItem = document.createElement("div");
        newItem.className = "medicine-item";
        newItem.innerHTML = `
          <input type="text" name="medicineName[]" placeholder="Medicine name" required />
          <input type="text" name="medicineDosage[]" placeholder="Dosage" required />
          <input type="text" name="medicineDuration[]" placeholder="Duration" required />
          <button type="button" class="remove-btn" onclick="removeMedicineItem(this)">
            <i class="fas fa-times"></i>
          </button>
        `;
        container.appendChild(newItem);
      }

      // Remove medicine item from form
      function removeMedicineItem(button) {
        const container = document.getElementById("medicinesContainer");
        if (container.children.length > 1) {
          button.parentElement.remove();
        } else {
          alert("At least one medicine is required");
        }
      }

      // Add test item to form
      function addTestItem() {
        const container = document.getElementById("testsContainer");
        const newItem = document.createElement("div");
        newItem.className = "test-item";
        newItem.innerHTML = `
          <input type="text" name="testName[]" placeholder="Test name" />
          <button type="button" class="remove-btn" onclick="removeTestItem(this)">
            <i class="fas fa-times"></i>
          </button>
        `;
        container.appendChild(newItem);
      }

      // Remove test item from form
      function removeTestItem(button) {
        const container = document.getElementById("testsContainer");
        if (container.children.length > 1) {
          button.parentElement.remove();
        }
      }

      // Handle prescription form submission
      createPrescriptionForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const appointmentId = formData.get("appointmentId");
        const patientId = formData.get("patientId");
        const notes = formData.get("notes");

        // Collect medicines
        const medicineNames = formData.getAll("medicineName[]");
        const medicineDosages = formData.getAll("medicineDosage[]");
        const medicineDurations = formData.getAll("medicineDuration[]");
        const medicines = medicineNames.map((name, index) => ({
          name,
          dosage: medicineDosages[index],
          duration: medicineDurations[index],
        }));

        // Collect tests
        const testNames = formData.getAll("testName[]");
        const tests = testNames
          .filter((name) => name.trim() !== "")
          .map((name) => ({ name }));

        try {
          const response = await fetch(`${API_BASE_URL}/doctor/prescriptions`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              appointmentId,
              doctorId: currentDoctor.id,
              patientId,
              medicines,
              tests,
              notes,
            }),
          });

          if (!response.ok) {
            throw new Error("Failed to create prescription");
          }

          const result = await response.json();
          alert("Prescription created successfully!");

          // Reset form
          this.reset();

          // Reload data
          loadDoctorAppointments();
          loadRecentPrescriptions();

          // Hide patient details
          patientDetails.style.display = "none";
        } catch (error) {
          console.error("Error creating prescription:", error);
          alert("Failed to create prescription. Please try again.");
        }
      });

      // Add this to your existing script
      document
        .getElementById("saveSlotsBtn")
        .addEventListener("click", async function () {
          const date = document.getElementById("slotDate").value;
          const checkboxes = document.querySelectorAll(
            '.time-slots input[type="checkbox"]:checked'
          );

          if (!date) {
            alert("Please select a date");
            return;
          }

          if (checkboxes.length === 0) {
            alert("Please select at least one time slot");
            return;
          }

          try {
            // Create array of promises for all slot additions
            const slotPromises = Array.from(checkboxes).map(async (cb) => {
              const time = cb.value;

              const response = await fetch(
                `${API_BASE_URL}/doctor/slots/${currentDoctor.id}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ date, time }),
                }
              );

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Failed to add slot");
              }

              return response.json();
            });

            // Wait for all slots to be added
            await Promise.all(slotPromises);

            alert("All slots added successfully!");
            document.getElementById("slotDate").value = "";
            document
              .querySelectorAll('.time-slots input[type="checkbox"]')
              .forEach((cb) => {
                cb.checked = false;
              });
          } catch (error) {
            console.error("Error adding slots:", error);
            alert(`Error: ${error.message}`);
          }
        });

      // Add this to your existing script
      async function loadDoctorSlots() {
        try {
          const response = await fetch(
            `${API_BASE_URL}/doctor/slots/${currentDoctor.id}`
          );
          const slots = await response.json();

          // Display slots in the UI (we'll create this element)
          displayAvailableSlots(slots);
        } catch (error) {
          console.error("Error loading slots:", error);
          alert("Failed to load available slots. Please try again.");
        }
      }

      function displayAvailableSlots(slots) {
        const slotsContainer = document.getElementById(
          "availableSlotsContainer"
        );

        if (!slotsContainer) {
          // Create container if it doesn't exist
          const slotManagementSection =
            document.getElementById("slot-management");
          const newContainer = document.createElement("div");
          newContainer.id = "availableSlotsContainer";
          newContainer.className = "available-slots-container";
          slotManagementSection.appendChild(newContainer);
        }

        const container = document.getElementById("availableSlotsContainer");
        container.innerHTML = "<h3>Your Available Slots</h3>";

        if (Object.keys(slots).length === 0) {
          container.innerHTML +=
            '<p class="no-slots">No available slots found.</p>';
          return;
        }

        for (const [date, times] of Object.entries(slots)) {
          const dateElement = document.createElement("div");
          dateElement.className = "slot-date-group";

          const dateHeader = document.createElement("h4");
          dateHeader.textContent = new Date(date).toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          const timesList = document.createElement("div");
          timesList.className = "slot-times";

          times.forEach((time) => {
            const timeElement = document.createElement("span");
            timeElement.className = "time-slot-badge";
            timeElement.textContent = time;
            timesList.appendChild(timeElement);
          });

          dateElement.appendChild(dateHeader);
          dateElement.appendChild(timesList);
          container.appendChild(dateElement);
        }
      }
    </script>
  </body>
</html>
